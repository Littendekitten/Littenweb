<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KittyCoins Trading</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
<style>
body{font-family:'Comfortaa',sans-serif; background:linear-gradient(135deg,#307cff,#e254ff); color:#333; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0;}
.container{background:#fff; padding:30px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.2); width:90%; max-width:550px;}
input{padding:10px; margin:6px; border-radius:8px; border:1px solid #ddd; width:calc(50% - 10px); text-align:center;}
button{padding:12px 20px; margin:5px; background:linear-gradient(90deg,#307cff,#e254ff); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;}
#message{margin-top:12px;}
table{border-collapse:collapse; width:100%; margin-top:10px;}
th,td{border:1px solid #aaa; padding:5px; text-align:center;}
</style>
</head>
<body>
<div class="container">
<h1>KittyCoins Trading</h1>
<p id="welcomeText"></p>
<p>Your balance: <span id="balance">0</span> KittyCoins</p>

<div class="input-group">
  <input type="number" id="kittyAmount" placeholder="Amount of KittyCoins">
  <input type="email" id="kittyEmail" placeholder="Recipient's Email">
</div>
<button id="tradeBtn">Send KittyCoins</button>
<div id="message"></div>

<!-- Admin button -->
<button id="adminBtn" style="display:none; margin-top:10px;">Admin Panel</button>

<!-- Admin panel -->
<div id="adminPanel" style="display:none; margin-top:20px; border:1px solid #aaa; padding:10px; border-radius:8px;">
  <h2>Admin Panel</h2>
  <table id="usersTable">
    <tr>
      <th>Email</th>
      <th>Balance</th>
      <th>Actions</th>
    </tr>
  </table>
</div>
</div>

<script src="datasave.js"></script>
<script>
const msg = document.getElementById("message");
const balanceSpan = document.getElementById("balance");
const welcomeText = document.getElementById("welcomeText");

const current = getCurrentUser();
if(!current){ window.location.href="index.html"; }

welcomeText.innerText = "Logged in as: " + current;

function updateBalanceUI(){
  balanceSpan.innerText = getBalance(current);
}
updateBalanceUI();

// Trade KittyCoins
document.getElementById("tradeBtn").addEventListener("click", ()=>{
  const amount = parseInt(document.getElementById("kittyAmount").value);
  const email = document.getElementById("kittyEmail").value.trim();
  const res = tradeKittyCoins(current,email,amount);
  if(!res.success){ msg.style.color="red"; msg.innerText=res.error; return; }
  msg.style.color="green";
  msg.innerText = `Sent ${amount} KittyCoins to ${email}!`;
  updateBalanceUI();
  document.getElementById("kittyAmount").value="";
  document.getElementById("kittyEmail").value="";
});

// Logout
const logoutBtn = document.createElement("button");
logoutBtn.innerText = "Logout";
logoutBtn.onclick = ()=>{
  logoutUser();
  window.location.href="index.html";
};
document.body.appendChild(logoutBtn);

// Admin button show
const adminBtn = document.getElementById("adminBtn");
if(isAdmin(current)){
  adminBtn.style.display="inline-block";
  adminBtn.onclick = ()=>{
    const pass = prompt("Enter admin password:");
    const verify = adminVerify(current, pass);
    if(!verify.success){ alert(verify.error); return; }
    showAdminPanel();
  }
}

// Admin panel functions
function showAdminPanel(){
  const panel = document.getElementById("adminPanel");
  const table = document.getElementById("usersTable");
  table.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());

  const allUsers = getAllUsersData();
  allUsers.forEach(user=>{
    const row = table.insertRow();
    row.insertCell(0).innerText = user.email;
    row.insertCell(1).innerText = user.balance;

    const actionsCell = row.insertCell(2);
    const adjBtn = document.createElement("button");
    adjBtn.innerText="Adjust";
    adjBtn.onclick = ()=>{
      const amt = parseInt(prompt(`Enter new balance for ${user.email}:`));
      if(!isNaN(amt) && amt>=0){
        adminSetBalance(user.email,amt);
        updateBalanceUI();
        showAdminPanel();
      }
    };
    const delBtn = document.createElement("button");
    delBtn.innerText="Delete";
    delBtn.style.marginLeft="5px";
    delBtn.onclick = ()=>{
      if(confirm(`Delete ${user.email}?`)){
        delete usersData[user.email];
        localStorage.setItem("usersData", JSON.stringify(usersData));
        updateBalanceUI();
        showAdminPanel();
      }
    };
    actionsCell.appendChild(adjBtn);
    actionsCell.appendChild(delBtn);
  });

  panel.style.display="block";
}
</script>
</body>
</html>
